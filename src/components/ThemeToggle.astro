---
import Icon from "./Icon.astro";
---

<button
    id="theme-toggle"
    class="h-9 w-9"
    onclick="toggleTheme()"
    transition:persist
>
    <Icon
        name="dark"
        class="darkicon transition-all"
        size={"1.2em"}
    />
    <Icon
        name="light"
        class="lighticon transition-all"
        size={"1.2em"}
    />
</button>

<script is:inline>
    function toggleTheme() {
        const element = document.documentElement;
        element.classList.toggle("light");
        element.classList.toggle("dark");

        const isDark = element.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    const applyTheme = () => {
        if (
            localStorage.getItem("theme") === "dark" ||
            (!("theme" in localStorage) &&
                window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
            document.documentElement.classList.add("dark");
            document.documentElement.classList.remove("light");
        } else {
            document.documentElement.classList.remove("dark");
            document.documentElement.classList.add("light");
        }
    };

    // Initialize immediately
    applyTheme();

    // Handle view transitions - re-attach event listener if needed
    document.addEventListener("astro:after-swap", function () {
        applyTheme();

        // Re-attach toggle handler if button exists but doesn't have onclick
        const toggleButton = document.getElementById("theme-toggle");
        if (toggleButton && !toggleButton.hasAttribute("onclick")) {
            toggleButton.addEventListener("click", toggleTheme);
        }
    });

    // Also initialize when DOM is ready (for page loads)
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyTheme);
    }
</script>